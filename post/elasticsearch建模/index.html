<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Elasticsearch建模 - lialzm的博客</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="lialzm" /><meta name="description" content="什么是数据建模 数据建模是一个用于定义和分析在组织的信息系统的范围内支持商业流程所需的数据要求的过程 数据类型 在索引的时候,如果字段第一次出现会" /><meta name="keywords" content="Hugo, theme, even" />



<meta name="google-site-verification" content="FIIaKlY_x-KycUQdEiprgoRI4KDltuH0LL5oAWTp__o" />


<meta name="generator" content="Hugo 0.88.1 with theme even" />


<link rel="canonical" href="https://lialzm.github.io/post/elasticsearch%E5%BB%BA%E6%A8%A1/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.b5a744db6de49a86cadafb3b70f555ab443f83c307a483402259e94726b045ff.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Elasticsearch建模" />
<meta property="og:description" content="什么是数据建模 数据建模是一个用于定义和分析在组织的信息系统的范围内支持商业流程所需的数据要求的过程 数据类型 在索引的时候,如果字段第一次出现会" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://lialzm.github.io/post/elasticsearch%E5%BB%BA%E6%A8%A1/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2018-07-17T11:46:20+00:00" />
<meta property="article:modified_time" content="2018-07-17T11:46:20+00:00" />

<meta itemprop="name" content="Elasticsearch建模">
<meta itemprop="description" content="什么是数据建模 数据建模是一个用于定义和分析在组织的信息系统的范围内支持商业流程所需的数据要求的过程 数据类型 在索引的时候,如果字段第一次出现会"><meta itemprop="datePublished" content="2018-07-17T11:46:20+00:00" />
<meta itemprop="dateModified" content="2018-07-17T11:46:20+00:00" />
<meta itemprop="wordCount" content="2857">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Elasticsearch建模"/>
<meta name="twitter:description" content="什么是数据建模 数据建模是一个用于定义和分析在组织的信息系统的范围内支持商业流程所需的数据要求的过程 数据类型 在索引的时候,如果字段第一次出现会"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">lialzm的博客</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">lialzm的博客</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Elasticsearch建模</h1>

      <div class="post-meta">
        <span class="post-time"> 2018-07-17 </span>
        
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#什么是数据建模">什么是数据建模</a></li>
    <li><a href="#数据类型">数据类型</a>
      <ul>
        <li><a href="#基本数据类型">基本数据类型</a>
          <ul>
            <li><a href="#日期类型">日期类型</a></li>
            <li><a href="#binary类型">binary类型</a></li>
          </ul>
        </li>
        <li><a href="#复合数据类型">复合数据类型</a>
          <ul>
            <li><a href="#数组">数组</a></li>
            <li><a href="#对象">对象</a></li>
          </ul>
        </li>
        <li><a href="#geo类型">Geo类型</a></li>
        <li><a href="#其他">其他</a></li>
      </ul>
    </li>
    <li><a href="#mapping">mapping</a>
      <ul>
        <li><a href="#相关参数">相关参数</a></li>
        <li><a href="#增删改查">增删改查</a></li>
        <li><a href="#索引模板index-templates">索引模板(Index Templates)</a></li>
        <li><a href="#动态映射">动态映射</a>
          <ul>
            <li><a href="#动态模板">动态模板</a></li>
            <li><a href="#动态字段映射">动态字段映射</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#补救错误的模型">补救错误的模型</a>
      <ul>
        <li><a href="#使用_reindex">使用_reindex</a>
          <ul>
            <li><a href="#例子reindex结合索引模板">例子:reindex结合索引模板</a></li>
            <li><a href="#例子reindex结合ingest-node">例子:reindex结合Ingest Node</a></li>
          </ul>
        </li>
        <li><a href="#update-by-query">Update By Query</a></li>
        <li><a href="#重新导入数据">重新导入数据</a></li>
      </ul>
    </li>
    <li><a href="#参考资料">参考资料</a></li>
  </ul>
</nav>
  </div>
</div>
  <div class="post-outdated">
    <div class="warn">
      <p>【注意】最后更新于 <span class="timeago" datetime="2018-07-17T11:46:20" title="July 17, 2018">July 17, 2018</span>，文中内容可能已过时，请谨慎使用。</p>
    </div>
  </div>
    <div class="post-content">
      <h1 id="什么是数据建模">什么是数据建模</h1>
<p>数据建模是一个用于定义和分析在组织的信息系统的范围内支持商业流程所需的数据要求的过程</p>
<h1 id="数据类型">数据类型</h1>
<ul>
<li>在索引的时候,如果字段第一次出现会自动是吧为某个类型</li>
<li>字段一旦设置了类型就不可更改</li>
</ul>
<h2 id="基本数据类型">基本数据类型</h2>
<p>字符串:text,keyword
数值型:long,interger,short,byte,double,float,half_float,scaled_float
布尔:boolean
日期:date
二进制:binary
范围类型:integer_rang,float_range,long_range,double_range,date_range</p>
<p>text和keyword的区别是text会被分词,一般text会自动创建一个keyword子类型</p>
<h3 id="日期类型">日期类型</h3>
<p>es中日期类型可以是以下几种</p>
<ol>
<li>日期格式的字符串：e.g. “2015-01-01” or “2015/01/01 12:10:30”.</li>
<li>long类型的毫秒数( milliseconds-since-the-epoch)</li>
<li>integer的秒数(seconds-since-the-epoch)</li>
<li>自定义格式</li>
</ol>
<h3 id="binary类型">binary类型</h3>
<p>binary类型接受base64编码的字符串，默认不存储也不可搜索</p>
<h2 id="复合数据类型">复合数据类型</h2>
<h3 id="数组">数组</h3>
<p>ELasticsearch没有专用的数组类型，默认情况下任何字段都可以包含一个或者多个值，但是<strong>一个数组中的值要是同一种类型</strong></p>
<p>例如:</p>
<ol>
<li>字符数组: [ “one”, “two” ]</li>
<li>整型数组：[1,3]</li>
<li>嵌套数组：[1,[2,3]],等价于[1,2,3]</li>
<li>对象数组：[ { “name”: “Mary”, “age”: 12 }, { “name”: “John”, “age”: 10 }]</li>
</ol>
<h3 id="对象">对象</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;user&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;Joe&#34;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>上面文档的Mapping</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;mappings&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;my_type&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;properties&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;user&#34;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&#34;properties&#34;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;interger&#34;</span>
            <span class="p">},</span>
            <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;text&#34;</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>或者</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;mappings&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;my_type&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;properties&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;user.age&#34;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;interger&#34;</span>
        <span class="p">},</span>
        <span class="nt">&#34;user.name&#34;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;text&#34;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="geo类型">Geo类型</h2>
<p>地理位置信息类型用于存储地理位置信息的经纬度</p>
<h2 id="其他">其他</h2>
<h1 id="mapping">mapping</h1>
<blockquote>
<p>类似于mysql中的表结构定义</p>
</blockquote>
<h2 id="相关参数">相关参数</h2>
<p>analyzer:指定分词器</p>
<p>normalizer</p>
<p>boost:字段级别的分数加权</p>
<p>coerce:字符串会被强转成数字，浮点型会被转成整形，经纬度会被转换为标准类型</p>
<p>copy_to:将字段复制到目标字段,不会出现再_source中,只用来搜索</p>
<p>doc_values:为了加快排序、聚合操作，在建立倒排索引的时候，额外增加一个列式存储映射，是一个空间换时间的做法。默认是开启的，对于确定不需要聚合或者排序的字段可以关闭</p>
<p>dynamic:用于检测新发现的字段，有三个取值：true:新发现的字段添加到映射中。（默认）flase:新检测的字段被忽略。必须显式添加新字段。strict:如果检测到新字段，就会引发异常并拒绝文档。</p>
<p>enabled:flase 时仅存储不做搜索或者聚合</p>
<p><strong>fielddata</strong>:默认为false,非常消耗内存,当text类型需要被聚合和排序时才打开</p>
<p>format:用于格式化日期</p>
<p>ignore_above:控制长度,字数大于ignore_above将不会被存储和索引</p>
<p>ignore_malformed:可以忽略不规则数据</p>
<p>include_in_all:设置是否此字段包含在_all字段中，默认是true，除非index设置成no选项</p>
<p>index_options:存储倒排索引的哪些信息</p>
<p><strong>index</strong>:控制当前字段是否索引，默认为 true，即记录索引，false 不记录，即不可搜索</p>
<p><strong>fields</strong>:可以让同一文本有多种不同的索引方式，比如一个String类型的字段，可以使用text类型做全文检索，使用keyword类型做聚合和排序</p>
<p>norms</p>
<p>null_value:设置一些缺失字段的初始化值，只有string可以使用，分词字段的null值也会被分词</p>
<p>position_increment_gap</p>
<p>properties</p>
<p>search_analyzer</p>
<p>similarity:指定文档评分模型</p>
<p><strong>store</strong>:是否存储具体的值</p>
<p>term_vector: 设置词向量</p>
<h2 id="增删改查">增删改查</h2>
<p>增加</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-plain" data-lang="plain">curl -XPUT &#34;http://elasticsearch:9200/{index_nmae}/_mapping/{type}&#34; -H &#39;Content-Type: application/json&#39; -d&#39;
{
  &#34;properties&#34;:{
    &#34;{field_name1}&#34;:{
      &#34;type&#34;:&#34;keyword&#34;
    },
    &#34;{field_name2}&#34;:{
      &#34;type&#34;:&#34;text&#34;
    }
  }
}&#39;
</code></pre></td></tr></table>
</div>
</div><p>获取已经定义的mapping</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-plain" data-lang="plain">curl -XGET &#34;http://elasticsearch:9200/{index_name}/_mapping/&#34;
</code></pre></td></tr></table>
</div>
</div><p>修改/删除</p>
<p>无法删除/修改已经创建的mapping,除非删除后重建索引</p>
<h2 id="索引模板index-templates">索引模板(Index Templates)</h2>
<blockquote>
<p>指定索引使用的映射,只对<strong>新建的索引生效</strong>,已经创建了的索引不受影响</p>
</blockquote>
<p>6.0之前</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-plain" data-lang="plain">curl -XPOST &#34;http://elasticsearch:9200/_template/{template_name}&#34; -H &#39;Content-Type: application/json&#39; -d&#39;
{
  &#34;template&#34;: &#34;myindex*&#34;, //想要匹配的索引,支持数组
  &#34;mappings&#34;: {
    &#34;{type}&#34;:{
      &#34;properties&#34;:{
        &#34;{field_name}&#34;:{
        &#34;type&#34;:&#34;integer&#34;
      }
      }
    }
  }
}&#39;
</code></pre></td></tr></table>
</div>
</div><p>6.0修改了api</p>
<p><code>template</code>字段改名为<code>index_patterns</code></p>
<p>查看索引模板</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-plain" data-lang="plain">curl -XGET &#34;http://elasticsearch:9200/{index_name}/_mapping&#34;
</code></pre></td></tr></table>
</div>
</div><p>或者</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-plain" data-lang="plain">curl -XGET &#34;http://elasticsearch:9200/_template/{template_name_regex}&#34;
</code></pre></td></tr></table>
</div>
</div><h2 id="动态映射">动态映射</h2>
<blockquote>
<p>自动的检测和添加新的类型以及字段的过程，称之为动态映射,我们可以自定义映射规则
es是依靠JSON文档的字段类型来实现自动识别字段类型</p>
</blockquote>
<p>支持的字段类型</p>
<p><img src="http://7fvicu.com1.z0.glb.clouddn.com/2018-06-18-141951.png" alt=""></p>
<h3 id="动态模板">动态模板</h3>
<blockquote>
<p>常见应用: 设置默认所有string类型不分词,指定字段开启分词,减少空间</p>
</blockquote>
<p>创建</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-plain" data-lang="plain">curl -XPUT &#34;http://elasticsearch:9200/{index_name}&#34; -H &#39;Content-Type: application/json&#39; -d&#39;
{
  &#34;mappings&#34;: {
    &#34;{type}&#34;: {
      &#34;dynamic_templates&#34;: [
        {
          &#34;{template_name}&#34;: {
            &#34;match_mapping_type&#34;: &#34;string&#34;, //指定匹配的类型
            &#34;mapping&#34;: {
              &#34;type&#34;: &#34;keyword&#34;
            }
          }
        }
      ]
    }
  }
}&#39;
</code></pre></td></tr></table>
</div>
</div><p>一共支持三种匹配方式类型匹配,字段名称匹配,按路径匹配</p>
<h3 id="动态字段映射">动态字段映射</h3>
<blockquote>
<p>默认情况,发现新的字段,es自动检测其 datatype 并将其加入到mapping type 中
通过一些设置,我们可以控制字段动态映射的方式,包括:日期类型检测、数值类型检测、自定义日期类型的格式等</p>
</blockquote>
<p>例子</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-plain" data-lang="plain">PUT my_index         //禁用日期类型检测
{
  &#34;mappings&#34;: {
    &#34;my_type&#34;: {
      &#34;date_detection&#34;: false
    }
  }
}
PUT my_index       //自定义日期类型的格式
{
  &#34;mappings&#34;: {
    &#34;my_type&#34;: {
      &#34;dynamic_date_formats&#34;: [&#34;MM/dd/yyyy&#34;]
    }
  }
}
PUT my_index        //启用数值类型检测
{
  &#34;mappings&#34;: {
    &#34;my_type&#34;: {
      &#34;numeric_detection&#34;: true
    }
  }
}
</code></pre></td></tr></table>
</div>
</div><h1 id="补救错误的模型">补救错误的模型</h1>
<blockquote>
<p>主要有两种手段:使用reindex重建索引和删除索引后重新导入数据</p>
</blockquote>
<h2 id="使用_reindex">使用_reindex</h2>
<p>基础api</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">curl -XPOST <span class="s2">&#34;http://elasticsearch:9200/_reindex&#34;</span> -H <span class="s1">&#39;Content-Type: application/json&#39;</span> -d<span class="s1">&#39;
</span><span class="s1">{
</span><span class="s1">  &#34;source&#34;: {
</span><span class="s1">    &#34;index&#34;: &#34;{index_name1}&#34;
</span><span class="s1">  },
</span><span class="s1">  &#34;dest&#34;: {
</span><span class="s1">    &#34;index&#34;: &#34;{index_name2}&#34;
</span><span class="s1">  }
</span><span class="s1">}&#39;</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="例子reindex结合索引模板">例子:reindex结合索引模板</h3>
<p>场景:index1某一个字段类型错误</p>
<p>一. 创建索引模板</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">curl -X POST <span class="s2">&#34;http://elasticsearch:9200/_template/tmp1&#34;</span> -H <span class="s1">&#39;Content-Type: application/json&#39;</span> -d<span class="s1">&#39;
</span><span class="s1">{
</span><span class="s1">  &#34;template&#34;: &#34;index*v2&#34;,
</span><span class="s1">  &#34;mappings&#34;: {
</span><span class="s1">    &#34;doc&#34;: {
</span><span class="s1">      &#34;properties&#34;: {
</span><span class="s1">        &#34;duration&#34;: {
</span><span class="s1">          &#34;type&#34;: &#34;long&#34;
</span><span class="s1">        }
</span><span class="s1">      }
</span><span class="s1">    }
</span><span class="s1">  }
</span><span class="s1">}&#39;</span>
</code></pre></td></tr></table>
</div>
</div><p>二. reindex</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-plain" data-lang="plain">curl -X POST &#34;http://elasticsearch:9200/_reindex&#34; -H &#39;Content-Type: application/json&#39; -d&#39;
{
  &#34;source&#34;: {
    &#34;index&#34;: &#34;index1&#34;
  },
  &#34;dest&#34;: {
    &#34;index&#34;: &#34;index1_v2&#34;
  }
}&#39;
</code></pre></td></tr></table>
</div>
</div><p>成功后删除原始索引</p>
<p>借助java代码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java">  <span class="n">Date</span> <span class="n">date</span> <span class="o">=</span> <span class="n">DateUtils</span><span class="o">.</span><span class="na">addDays</span><span class="o">(</span><span class="n">DateUtils</span><span class="o">.</span><span class="na">parseDate</span><span class="o">(</span><span class="s">&#34;2018.06.01&#34;</span><span class="o">,</span> <span class="s">&#34;yyyy.MM.dd&#34;</span><span class="o">),</span> <span class="n">1</span><span class="o">);</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">DateUtils</span><span class="o">.</span><span class="na">truncatedCompareTo</span><span class="o">(</span><span class="n">DateUtils</span><span class="o">.</span><span class="na">parseDate</span><span class="o">(</span><span class="s">&#34;2018.06.20&#34;</span><span class="o">,</span><span class="s">&#34;yyyy.MM.dd&#34;</span><span class="o">),</span><span class="n">date</span><span class="o">,</span><span class="n">Calendar</span><span class="o">.</span><span class="na">DATE</span><span class="o">)!=-</span><span class="n">1</span><span class="o">){</span>
            <span class="n">String</span> <span class="n">time</span> <span class="o">=</span> <span class="n">DateFormatUtils</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">date</span><span class="o">,</span> <span class="s">&#34;yyyy.MM.dd&#34;</span><span class="o">);</span>
            <span class="n">Process</span> <span class="n">process</span> <span class="o">=</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="k">new</span> <span class="n">String</span><span class="o">[]{</span><span class="s">&#34;curl&#34;</span><span class="o">,</span> <span class="s">&#34;-X&#34;</span><span class="o">,</span> <span class="s">&#34;POST&#34;</span><span class="o">,</span> <span class="s">&#34;http://127.0.0.1:9200/_reindex?wait_for_completion=false&#34;</span><span class="o">,</span> <span class="s">&#34;-H&#34;</span><span class="o">,</span> <span class="s">&#34;Content-Type: application/json&#34;</span><span class="o">,</span> <span class="s">&#34;-d&#34;</span><span class="o">,</span> <span class="s">&#34;{\n&#34;</span> <span class="o">+</span>
                    <span class="s">&#34;  \&#34;source\&#34;: {\n&#34;</span> <span class="o">+</span>
                    <span class="s">&#34;    \&#34;index\&#34;: \&#34;api-&#34;</span> <span class="o">+</span> <span class="n">time</span> <span class="o">+</span> <span class="s">&#34;\&#34;\n&#34;</span> <span class="o">+</span>
                    <span class="s">&#34;  },\n&#34;</span> <span class="o">+</span>
                    <span class="s">&#34;  \&#34;dest\&#34;: {\n&#34;</span> <span class="o">+</span>
                    <span class="s">&#34;    \&#34;index\&#34;: \&#34;api-\&#34;\n&#34;</span> <span class="o">+</span>
                    <span class="s">&#34;  },\n&#34;</span> <span class="o">+</span>
                    <span class="s">&#34;  \&#34;script\&#34;: {\n&#34;</span> <span class="o">+</span>
                    <span class="s">&#34;    \&#34;lang\&#34;: \&#34;painless\&#34;,\n&#34;</span> <span class="o">+</span>
                    <span class="s">&#34;    \&#34;source\&#34;: \&#34;ctx._index = &#39;api-&#39; + (ctx._index.substring(&#39;api-&#39;.length(), ctx._index.length())) + &#39;_v2&#39;\&#34;\n&#34;</span> <span class="o">+</span>
                    <span class="s">&#34;  }\n&#34;</span> <span class="o">+</span>
                    <span class="s">&#34;}&#34;</span><span class="o">});</span>
            <span class="n">String</span> <span class="n">json</span> <span class="o">=</span> <span class="n">IOUtils</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">process</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">());</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;json==&#34;</span> <span class="o">+</span> <span class="n">json</span><span class="o">);</span>
            <span class="n">JSONObject</span> <span class="n">jsonObject</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">json</span><span class="o">);</span>
            <span class="n">String</span> <span class="n">taskkId</span> <span class="o">=</span> <span class="n">jsonObject</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&#34;task&#34;</span><span class="o">);</span>
            <span class="n">String</span> <span class="n">taskp</span> <span class="o">=</span> <span class="s">&#34;curl -X GET http://127.0.0.1:9200/_tasks/&#34;</span> <span class="o">+</span> <span class="n">taskkId</span><span class="o">;</span>
            <span class="n">Process</span> <span class="n">process1</span> <span class="o">=</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="n">taskp</span><span class="o">);</span>
            <span class="n">String</span> <span class="n">json1</span> <span class="o">=</span> <span class="n">IOUtils</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">process1</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">());</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">json1</span><span class="o">);</span>
            <span class="n">JSONObject</span> <span class="n">jsonObject1</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">json1</span><span class="o">);</span>
            <span class="k">while</span> <span class="o">(!</span><span class="n">jsonObject1</span><span class="o">.</span><span class="na">getBoolean</span><span class="o">(</span><span class="s">&#34;completed&#34;</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">process1</span> <span class="o">=</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="n">taskp</span><span class="o">);</span>
                <span class="n">json1</span> <span class="o">=</span> <span class="n">IOUtils</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">process1</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">());</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">json1</span><span class="o">);</span>
                <span class="n">jsonObject1</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">json1</span><span class="o">);</span>
                <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">10</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;----------------&#34;</span><span class="o">);</span>
            <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="s">&#34;curl -X DELETE http://127.0.0.1:9200/api-&#34;</span> <span class="o">+</span><span class="n">time</span><span class="o">);</span>
            <span class="n">date</span><span class="o">=</span><span class="n">DateUtils</span><span class="o">.</span><span class="na">addDays</span><span class="o">(</span><span class="n">date</span><span class="o">,</span><span class="n">1</span><span class="o">);</span>
            <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">10</span><span class="o">);</span>
        <span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="例子reindex结合ingest-node">例子:reindex结合Ingest Node</h3>
<p>场景: 比如只保存了ip地址但是没有保存geo</p>
<p>先安装官方的geoip插件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">/usr/share/elasticsearch/bin/elasticsearch-plugin install ingest-geoip
</code></pre></td></tr></table>
</div>
</div><p>然后创建一个pipline</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-plain" data-lang="plain">PUT _ingest/pipeline/&lt;自定义id&gt;
{
    &#34;test&#34;: {
        &#34;description&#34;: &#34;将ip编程geo&#34;,
        &#34;processors&#34;: [
            {
                &#34;geoip&#34;: {
                    &#34;field&#34;: &#34;&lt;保存ip的字段&gt;&#34;
                }
            }
        ]
    }
}
</code></pre></td></tr></table>
</div>
</div><p>最后在reindex的时候使用转换器</p>
<h2 id="update-by-query">Update By Query</h2>
<p>场景: 字段缺失,但是其他字段包含了所需信息</p>
<p>用法查看官网</p>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-update-by-query.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-update-by-query.html</a></p>
<h2 id="重新导入数据">重新导入数据</h2>
<p>如果重新导入数据,源数据最好有时间标识</p>
<h1 id="参考资料">参考资料</h1>
<p><a href="https://blog.csdn.net/napoay/article/details/73100110">Elasticsearch 5.4 Mapping详解 - CSDN博客</a></p>
<p><a href="https://www.cnblogs.com/licongyu/p/5497298.html">mapping 详解5（dynamic mapping） - SomerOS - 博客园</a></p>
<p><a href="https://www.elastic.co/blog/geoip-in-the-elastic-stack">安装geoip</a></p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">lialzm</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2018-07-17
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      
      <nav class="post-nav">
        <a class="prev" href="/post/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%E6%A6%82%E5%BF%B5%E4%BB%8B%E7%BB%8D/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">数据仓库概念介绍</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/log4j%E9%85%8D%E7%BD%AE%E7%BB%8F%E9%AA%8C/">
            <span class="next-text nav-default">log4j配置经验</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://lialzm.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2017 - 
    2021<span class="heart"><i class="iconfont icon-heart"></i></span><span>lialzm</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago.js@3.0.2/dist/timeago.min.js" integrity="sha256-jwCP0NAdCBloaIWTWHmW4i3snUNMHUNO+jr9rYd2iOI=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago.js@3.0.2/dist/timeago.locales.min.js" integrity="sha256-ZwofwC1Lf/faQCzN7nZtfijVV6hSwxjQMwXL4gn9qU8=" crossorigin="anonymous"></script>
  <script><!-- NOTE: timeago.js uses the language code format like "zh_CN" (underscore and case sensitive) -->
    var languageCode = "en".replace(/-/g, '_').replace(/_(.*)/, function ($0, $1) {return $0.replace($1, $1.toUpperCase());});
    timeago().render(document.querySelectorAll('.timeago'), languageCode);
    timeago.cancel();  
  </script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>








</body>
</html>
